<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asteroid Orbit Analysis Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0a;
            color: #fff;
            overflow: hidden;
            height: 100vh;
        }
        .container {
            display: flex;
            height: 100vh;
        }
        
        /* Professional Navbar */
        #nav-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            z-index: 1002;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        #nav-toggle:hover {
            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.7);
        }
        #nav-toggle::before {
            content: '';
            width: 24px;
            height: 18px;
            background: 
                linear-gradient(#fff, #fff) 0 0,
                linear-gradient(#fff, #fff) 0 50%,
                linear-gradient(#fff, #fff) 0 100%;
            background-size: 100% 2px;
            background-repeat: no-repeat;
        }
        #nav-toggle.active::before {
            background: 
                linear-gradient(45deg, transparent 40%, #fff 40%, #fff 60%, transparent 60%),
                linear-gradient(-45deg, transparent 40%, #fff 40%, #fff 60%, transparent 60%);
            background-size: 100% 100%;
            background-repeat: no-repeat;
        }

        /* Left Panel with Icons */
        #left-panel {
            width: 420px;
            background: linear-gradient(180deg, rgba(10, 15, 35, 0.98) 0%, rgba(15, 20, 40, 0.95) 100%);
            backdrop-filter: blur(25px);
            border-right: 1px solid rgba(100, 150, 255, 0.15);
            box-shadow: 4px 0 30px rgba(0, 0, 0, 0.5);
            overflow-y: auto;
            padding: 80px 24px 24px 24px;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
        }
        #left-panel.hidden {
            transform: translateX(-420px);
        }
        #left-panel::-webkit-scrollbar {
            width: 8px;
        }
        #left-panel::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }
        #left-panel::-webkit-scrollbar-thumb {
            background: rgba(100, 150, 255, 0.4);
            border-radius: 4px;
        }

        /* Feature Navigation Icons */
        .feature-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .feature-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, rgba(30, 35, 60, 0.8) 0%, rgba(25, 30, 50, 0.8) 100%);
            border: 1px solid rgba(100, 150, 255, 0.3);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 24px;
        }
        .feature-icon:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.5);
        }
        .feature-icon.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
        }

        .section {
            background: linear-gradient(135deg, rgba(30, 35, 60, 0.7) 0%, rgba(25, 30, 50, 0.7) 100%);
            border: 1px solid rgba(100, 150, 255, 0.25);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            display: none;
        }
        .section.active {
            display: block;
        }
        .section:hover {
            border-color: rgba(100, 150, 255, 0.4);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.4);
        }
        .section-title {
            font-size: 19px;
            font-weight: 700;
            background: linear-gradient(135deg, #64b5f6 0%, #8e99f3 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
            letter-spacing: 0.5px;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            margin: 12px 0;
            font-size: 14px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(100, 150, 255, 0.1);
        }
        .info-row:last-child {
            border-bottom: none;
        }
        .info-label {
            color: #90caf9;
            font-weight: 500;
        }
        .info-value {
            color: #fff;
            text-align: right;
        }
        .input-group {
            margin: 12px 0;
        }
        .input-group label {
            display: block;
            color: #90caf9;
            font-size: 12px;
            margin-bottom: 6px;
            font-weight: 500;
        }
        .input-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        input[type="number"], input[type="range"], input[type="text"] {
            background: rgba(50, 60, 100, 0.6);
            border: 1px solid rgba(100, 150, 255, 0.35);
            color: #fff;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
        }
        input[type="number"], input[type="text"] {
            width: 110px;
        }
        input[type="text"] {
            width: 100%;
        }
        input[type="range"] {
            flex: 1;
            padding: 0;
            height: 6px;
            cursor: pointer;
        }
        input:focus {
            border-color: #64b5f6;
            background: rgba(60, 70, 110, 0.7);
            box-shadow: 0 0 15px rgba(100, 181, 246, 0.4);
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, #64b5f6 0%, #8e99f3 100%);
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(100, 181, 246, 0.5);
        }
        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, #64b5f6 0%, #8e99f3 100%);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(100, 181, 246, 0.5);
        }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 14px 22px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 700;
            width: 100%;
            margin: 10px 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.35);
            position: relative;
            overflow: hidden;
        }
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        .btn:hover::before {
            left: 100%;
        }
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.6);
        }
        .btn:active {
            transform: translateY(-1px);
        }
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            box-shadow: 0 6px 20px rgba(56, 239, 125, 0.35);
        }
        .btn-success:hover {
            box-shadow: 0 10px 30px rgba(56, 239, 125, 0.6);
        }
        .btn-danger {
            background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
            box-shadow: 0 6px 20px rgba(238, 9, 121, 0.35);
        }
        .btn-danger:hover {
            box-shadow: 0 10px 30px rgba(238, 9, 121, 0.6);
        }
        .control-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .collision-warning {
            background: rgba(255, 50, 50, 0.2);
            border: 2px solid #ff5252;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .collision-safe {
            background: rgba(50, 255, 150, 0.2);
            border: 2px solid #69f0ae;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .impact-info {
            font-size: 13px;
            margin: 8px 0;
        }
        .hazard-yes {
            color: #ff5252;
            font-weight: bold;
        }
        .hazard-no {
            color: #69f0ae;
        }
        
        /* Right Panel */
        #right-panel {
            position: fixed;
            left: 420px;
            top: 0;
            right: 0;
            height: 100vh;
            background: #000;
            transition: left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #right-panel.expanded {
            left: 0;
        }
        canvas {
            display: block;
        }
        #hud {
            position: absolute;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, rgba(15, 20, 40, 0.95) 0%, rgba(20, 25, 45, 0.92) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(100, 150, 255, 0.3);
            border-radius: 16px;
            padding: 24px;
            min-width: 280px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }
        .hud-title {
            font-size: 18px;
            background: linear-gradient(135deg, #64b5f6 0%, #8e99f3 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 16px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        .hud-item {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 14px;
            padding: 6px 0;
            border-bottom: 1px solid rgba(100, 150, 255, 0.1);
        }
        .hud-item:last-child {
            border-bottom: none;
        }
        .hud-label {
            color: #90caf9;
        }
        .hud-value {
            color: #fff;
            font-weight: 500;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 20px;
            background: rgba(15, 15, 30, 0.95);
            padding: 30px 50px;
            border-radius: 15px;
            border: 2px solid rgba(100, 150, 255, 0.5);
            text-align: center;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(50, 50, 80, 0.5);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }
        .timeline-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .timeline-controls button {
            flex: 1;
            padding: 8px;
            font-size: 18px;
        }
        #collision-impact {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 0, 0, 0.95);
            border: 3px solid #ff0000;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            z-index: 2000;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 30px rgba(255, 0, 0, 0.8); }
            50% { box-shadow: 0 0 60px rgba(255, 0, 0, 1); }
        }
        #collision-impact h2 {
            font-size: 36px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="nav-toggle"></div>
        
        <div id="left-panel">
            <!-- Feature Navigation -->
            <div class="feature-nav">
                <div class="feature-icon active" data-feature="asteroid" title="Asteroid Info">🌑</div>
                <div class="feature-icon" data-feature="orbital" title="Orbital Elements">🛸</div>
                <div class="feature-icon" data-feature="physical" title="Physical Properties">⚙️</div>
                <div class="feature-icon" data-feature="simulation" title="Simulation">▶️</div>
                <div class="feature-icon" data-feature="collision" title="Collision Analysis">💥</div>
                <div class="feature-icon" data-feature="ai" title="AI Agent">🤖</div>
                <div class="feature-icon" data-feature="export" title="Export">💾</div>
            </div>

            <!-- Asteroid Search -->
            <div class="section active" id="section-asteroid">
                <div class="section-title">🌑 Asteroid Data</div>
                <div class="input-group">
                    <label>Asteroid ID (NASA)</label>
                    <p type="text" id="asteroid-id"></p>
                </div>
                <button class="btn btn-success" id="btn-fetch">🔄 Fetch from NASA API</button>
                
                <div id="asteroid-info-display">
                    <div class="info-row">
                        <span class="info-label">Name:</span>
                        <span class="info-value" id="ast-name">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ID:</span>
                        <span class="info-value" id="ast-id">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Orbit Class:</span>
                        <span class="info-value" id="ast-class">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Hazardous:</span>
                        <span class="info-value hazard-no" id="ast-hazard">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Diameter:</span>
                        <span class="info-value" id="ast-diameter">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Abs. Magnitude:</span>
                        <span class="info-value" id="ast-mag">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Next Approach:</span>
                        <span class="info-value" id="ast-approach">-</span>
                    </div>
                </div>
            </div>

            <!-- Orbital Elements -->
            <div class="section" id="section-orbital">
                <div class="section-title">🛸 Orbital Elements</div>
                <div class="input-group">
                    <label>Semi-major Axis (a) - AU</label>
                    <div class="input-row">
                        <input type="range" id="slider-a" min="0.5" max="3" step="0.01" value="1">
                        <input type="number" id="input-a" min="0.5" max="3" step="0.01" value="1">
                    </div>
                </div>
                <div class="input-group">
                    <label>Eccentricity (e)</label>
                    <div class="input-row">
                        <input type="range" id="slider-e" min="0" max="0.9" step="0.001" value="0">
                        <input type="number" id="input-e" min="0" max="0.9" step="0.001" value="0">
                    </div>
                </div>
                <div class="input-group">
                    <label>Inclination (i) - degrees</label>
                    <div class="input-row">
                        <input type="range" id="slider-i" min="0" max="180" step="0.1" value="0">
                        <input type="number" id="input-i" min="0" max="180" step="0.1" value="0">
                    </div>
                </div>
                <div class="input-group">
                    <label>RAAN (Ω) - degrees</label>
                    <div class="input-row">
                        <input type="range" id="slider-omega" min="0" max="360" step="0.1" value="0">
                        <input type="number" id="input-omega" min="0" max="360" step="0.1" value="0">
                    </div>
                </div>
                <div class="input-group">
                    <label>Arg. of Periapsis (ω) - degrees</label>
                    <div class="input-row">
                        <input type="range" id="slider-w" min="0" max="360" step="0.1" value="0">
                        <input type="number" id="input-w" min="0" max="360" step="0.1" value="0">
                    </div>
                </div>
                <div class="input-group">
                    <label>Mean Anomaly (M₀) - degrees</label>
                    <div class="input-row">
                        <input type="range" id="slider-m" min="0" max="360" step="0.1" value="0">
                        <input type="number" id="input-m" min="0" max="360" step="0.1" value="0">
                    </div>
                </div>
                <button class="btn btn-success" id="btn-recompute">🔄 Recompute Orbit</button>
            </div>

            <!-- Physical Properties -->
            <div class="section" id="section-physical">
                <div class="section-title">⚙️ Physical Properties</div>
                <div class="info-row">
                    <span class="info-label">Diameter:</span>
                    <span class="info-value" id="phys-diameter">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Velocity:</span>
                    <span class="info-value" id="phys-velocity">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Orbital Period:</span>
                    <span class="info-value" id="phys-period">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Mean Motion:</span>
                    <span class="info-value" id="phys-motion">-</span>
                </div>
            </div>

            <!-- Simulation Controls -->
            <div class="section" id="section-simulation">
                <div class="section-title">▶️ Simulation Controls</div>
                <div class="control-grid">
                    <button class="btn" id="btn-play">▶️ Play</button>
                    <button class="btn" id="btn-pause">⏸️ Pause</button>
                    <button class="btn" id="btn-slow">🐢 0.5x</button>
                    <button class="btn" id="btn-fast">⚡ 5x</button>
                </div>
                <div class="input-group">
                    <label>Time Scale</label>
                    <div class="input-row">
                        <input type="range" id="slider-speed" min="0.1" max="10" step="0.1" value="1">
                        <input type="number" id="input-speed" min="0.1" max="10" step="0.1" value="1">
                    </div>
                </div>
                <div class="timeline-controls">
                    <button class="btn" id="btn-backward">⏪</button>
                    <button class="btn" id="btn-forward">⏩</button>
                    <button class="btn" id="btn-reset">🔄 Reset</button>
                </div>
            </div>

            <!-- Collision Analysis -->
            <div class="section" id="section-collision">
                <div class="section-title">💥 Collision Analysis</div>
                <button class="btn btn-danger" id="btn-collision">🔬 Run Analysis</button>
                <div id="collision-result"></div>
                <div class="input-group">
                    <label>Monte Carlo Samples</label>
                    <input type="number" id="input-samples" min="100" max="10000" step="100" value="1000">
                </div>
                <div class="progress-bar" id="progress-bar" style="display:none;">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
            </div>

            <!-- AI Agent -->
            <div class="section" id="section-ai">
                <div class="section-title">🤖 AI Agent Analysis</div>
                <p style="color: #90caf9; margin-bottom: 15px;">Get AI-powered insights about the asteroid's trajectory and collision risk.</p>
                <button class="btn" id="btn-ai-analyze">🧠 Analyze with AI</button>
                <div id="ai-result" style="margin-top: 15px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px; display: none;">
                    <div style="color: #90caf9; margin-bottom: 10px; font-weight: bold;">AI Analysis:</div>
                    <div id="ai-text" style="color: #fff; line-height: 1.6;"></div>
                </div>
            </div>

            <!-- Export Options -->
            <div class="section" id="section-export">
                <div class="section-title">💾 Export Options</div>
                <button class="btn" id="btn-export-img">📷 Export PNG Snapshot</button>
                <button class="btn" id="btn-export-json">📊 Export JSON Data</button>
            </div>
        </div>

        <div id="right-panel">
            <div id="loading">⏳ Please fetch asteroid data to begin...</div>
            <div id="collision-impact">
                <h2>⚠️ COLLISION DETECTED!</h2>
                <p style="font-size: 20px;">Asteroid has impacted Earth</p>
                <button class="btn" id="btn-continue" style="margin-top: 20px;">Continue Simulation</button>
            </div>
            <div id="hud">
                <div class="hud-title">🎯 Real-time Data</div>
                <div class="hud-item">
                    <span class="hud-label">Simulation Time:</span>
                    <span class="hud-value" id="hud-time">Day 0</span>
                </div>
                <div class="hud-item">
                    <span class="hud-label">True Anomaly:</span>
                    <span class="hud-value" id="hud-anomaly">0.00°</span>
                </div>
                <div class="hud-item">
                    <span class="hud-label">Asteroid Speed:</span>
                    <span class="hud-value" id="hud-speed">0.00 km/s</span>
                </div>
                <div class="hud-item">
                    <span class="hud-label">Distance to Earth:</span>
                    <span class="hud-value" id="hud-distance">0.00 million km</span>
                </div>
                <div class="hud-item">
                    <span class="hud-label">Current Radius:</span>
                    <span class="hud-value" id="hud-radius">0.00 AU</span>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // Constants
        const AU_TO_KM = 149597870.7;
        const AU_TO_UNITS = 300;
        const EARTH_RADIUS_KM = 6371;
        const EARTH_RADIUS_UNITS = 30;
        const MU_SUN = 1.32712440018e11;
        const BACKEND_URL = 'http://127.0.0.1:5000';
        const EARTH_AXIAL_TILT = 23.5 * Math.PI / 180; // Earth's axial tilt in radians

        // Scene setup with enhanced rendering
        const scene = new THREE.Scene();
        scene.fog = new THREE.Fog(0x000000, 1000, 5000);
        
        const rightPanel = document.getElementById('right-panel');
        const camera = new THREE.PerspectiveCamera(60, rightPanel.offsetWidth / rightPanel.offsetHeight, 0.1, 10000);
        const renderer = new THREE.WebGLRenderer({ 
            antialias: true, 
            preserveDrawingBuffer: true,
            powerPreference: "high-performance"
        });
        
        renderer.setSize(rightPanel.offsetWidth, rightPanel.offsetHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.2;
        rightPanel.appendChild(renderer.domElement);

        // Enhanced Starfield with multiple layers
        const starfieldGroup = new THREE.Group();
        
        // Bright stars layer
        const brightStarGeometry = new THREE.BufferGeometry();
        const brightStarVertices = [];
        for (let i = 0; i < 3000; i++) {
            brightStarVertices.push(
                (Math.random() - 0.5) * 8000,
                (Math.random() - 0.5) * 8000,
                (Math.random() - 0.5) * 8000
            );
        }
        brightStarGeometry.setAttribute('position', new THREE.Float32BufferAttribute(brightStarVertices, 3));
        const brightStars = new THREE.Points(
            brightStarGeometry,
            new THREE.PointsMaterial({ 
                color: 0xffffff, 
                size: 4,
                sizeAttenuation: true,
                transparent: true,
                opacity: 1
            })
        );
        starfieldGroup.add(brightStars);
        
        // Dim stars layer
        const dimStarGeometry = new THREE.BufferGeometry();
        const dimStarVertices = [];
        for (let i = 0; i < 10000; i++) {
            dimStarVertices.push(
                (Math.random() - 0.5) * 10000,
                (Math.random() - 0.5) * 10000,
                (Math.random() - 0.5) * 10000
            );
        }
        dimStarGeometry.setAttribute('position', new THREE.Float32BufferAttribute(dimStarVertices, 3));
        const dimStars = new THREE.Points(
            dimStarGeometry,
            new THREE.PointsMaterial({ 
                color: 0xaaaaaa, 
                size: 1.5,
                sizeAttenuation: true,
                transparent: true,
                opacity: 0.7
            })
        );
        starfieldGroup.add(dimStars);
        
        scene.add(starfieldGroup);

        // Enhanced Lighting
        scene.add(new THREE.AmbientLight(0x404040, 0.3));
        
        // Main sun light with shadows
        const sunLight = new THREE.PointLight(0xffffff, 3, 0);
        sunLight.castShadow = true;
        sunLight.shadow.mapSize.width = 2048;
        sunLight.shadow.mapSize.height = 2048;
        sunLight.shadow.camera.near = 0.5;
        sunLight.shadow.camera.far = 5000;
        scene.add(sunLight);

        // Add rim light for better 3D effect
        const rimLight = new THREE.DirectionalLight(0x4488ff, 0.5);
        rimLight.position.set(-100, 100, -100);
        scene.add(rimLight);

        // Enhanced Sun with glow effect
        const sunGroup = new THREE.Group();
        
        // Sun core
        const sunGeometry = new THREE.SphereGeometry(15, 64, 64);
        const sunMaterial = new THREE.MeshBasicMaterial({ 
            color: 0xffd700,
            emissive: 0xffd700,
            emissiveIntensity: 2
        });
        const sun = new THREE.Mesh(sunGeometry, sunMaterial);
        sunGroup.add(sun);
        
        // Sun glow
        const sunGlowGeometry = new THREE.SphereGeometry(25, 32, 32);
        const sunGlowMaterial = new THREE.MeshBasicMaterial({
            color: 0xffaa00,
            transparent: true,
            opacity: 0.4,
            side: THREE.BackSide
        });
        const sunGlow = new THREE.Mesh(sunGlowGeometry, sunGlowMaterial);
        sunGroup.add(sunGlow);
        
        // Sun corona
        const coronaGeometry = new THREE.SphereGeometry(35, 32, 32);
        const coronaMaterial = new THREE.MeshBasicMaterial({
            color: 0xff8800,
            transparent: true,
            opacity: 0.2,
            side: THREE.BackSide
        });
        const sunCorona = new THREE.Mesh(coronaGeometry, coronaMaterial);
        sunGroup.add(sunCorona);
        
        scene.add(sunGroup);

        // Earth Container (for orbital positioning)
        const earthContainer = new THREE.Object3D();
        scene.add(earthContainer);

        // Enhanced Earth with realistic appearance
        const earthGroup = new THREE.Group();
        
        // Earth sphere with detailed material
        const earthGeometry = new THREE.SphereGeometry(EARTH_RADIUS_UNITS, 128, 128);
        
        // Create Earth texture with procedural colors
        const earthMaterial = new THREE.MeshPhongMaterial({
            color: 0x2244aa,
            emissive: 0x112244,
            emissiveIntensity: 0.1,
            shininess: 100,
            specular: 0x333333,
            flatShading: false
        });
        
        const earth = new THREE.Mesh(earthGeometry, earthMaterial);
        earth.castShadow = true;
        earth.receiveShadow = true;
        earth.rotation.z = EARTH_AXIAL_TILT;
        earthGroup.add(earth);
        
        // Add continental details (simple colored patches)
        const continentGeometry = new THREE.SphereGeometry(EARTH_RADIUS_UNITS + 0.1, 64, 64, 0, Math.PI * 0.5);
        const continentMaterial = new THREE.MeshPhongMaterial({
            color: 0x228844,
            emissive: 0x112211,
            transparent: true,
            opacity: 0.6
        });
        const continent = new THREE.Mesh(continentGeometry, continentMaterial);
        earth.add(continent);
        
        // Enhanced atmosphere with multiple layers
        const atmosphereGroup = new THREE.Group();
        
        // Inner atmosphere
        const innerAtmosphere = new THREE.Mesh(
            new THREE.SphereGeometry(EARTH_RADIUS_UNITS + 2, 64, 64),
            new THREE.MeshBasicMaterial({
                color: 0x88aaff,
                transparent: true,
                opacity: 0.3,
                side: THREE.BackSide
            })
        );
        atmosphereGroup.add(innerAtmosphere);
        
        // Outer atmosphere
        const outerAtmosphere = new THREE.Mesh(
            new THREE.SphereGeometry(EARTH_RADIUS_UNITS + 4, 64, 64),
            new THREE.MeshBasicMaterial({
                color: 0x4488ff,
                transparent: true,
                opacity: 0.15,
                side: THREE.BackSide
            })
        );
        atmosphereGroup.add(outerAtmosphere);
        
        earth.add(atmosphereGroup);
        
        // Cloud layer
        const cloudGeometry = new THREE.SphereGeometry(EARTH_RADIUS_UNITS + 1, 64, 64);
        const cloudMaterial = new THREE.MeshPhongMaterial({
            color: 0xffffff,
            transparent: true,
            opacity: 0.3,
            emissive: 0xffffff,
            emissiveIntensity: 0.1
        });
        const clouds = new THREE.Mesh(cloudGeometry, cloudMaterial);
        earth.add(clouds);
        
        // Visual axis indicator
        const axisGeometry = new THREE.CylinderGeometry(0.5, 0.5, EARTH_RADIUS_UNITS * 3, 8);
        const axisMaterial = new THREE.MeshBasicMaterial({ 
            color: 0xffffff, 
            transparent: true, 
            opacity: 0.2 
        });
        const earthAxis = new THREE.Mesh(axisGeometry, axisMaterial);
        earth.add(earthAxis);
        
        earthContainer.add(earthGroup);

        // Enhanced Earth orbit with gradient effect
        const earthOrbitRadius = 300;
        const earthEccentricity = 0.0167;
        
        // Create bold orbit line for Earth
        function createBoldOrbitLine(a, e, i, omega, w, color, segments = 1200) {
            const orbitGroup = new THREE.Group();
            
            // Main orbit line
            const points = [];
            for (let j = 0; j <= segments; j++) {
                const M = (j / segments) * 2 * Math.PI;
                const pos = orbitalToCartesian(a, e, i, omega, w, M * 180 / Math.PI);
                points.push(new THREE.Vector3(pos.x, pos.y, pos.z));
            }
            
            // Create thick line using TubeGeometry
            const curve = new THREE.CatmullRomCurve3(points, true);
            const tubeGeometry = new THREE.TubeGeometry(curve, segments, 1.5, 8, true);
            const tubeMaterial = new THREE.MeshBasicMaterial({ 
                color: color,
                transparent: true,
                opacity: 0.9
            });
            const tube = new THREE.Mesh(tubeGeometry, tubeMaterial);
            orbitGroup.add(tube);
            
            // Add glow effect
            const glowGeometry = new THREE.TubeGeometry(curve, segments, 3, 8, true);
            const glowMaterial = new THREE.MeshBasicMaterial({ 
                color: color,
                transparent: true,
                opacity: 0.3
            });
            const glow = new THREE.Mesh(glowGeometry, glowMaterial);
            orbitGroup.add(glow);
            
            return orbitGroup;
        }
        
        let earthOrbitLine = createBoldOrbitLine(earthOrbitRadius, earthEccentricity, 0, 0, 0, 0x4488ff);
        scene.add(earthOrbitLine);

        // Enhanced Asteroid with rocky appearance
        const asteroidGroup = new THREE.Group();
        
        // Create irregular asteroid shape
        const asteroidGeometry = new THREE.DodecahedronGeometry(8, 1);
        
        // Deform vertices for irregular shape
        const positionAttribute = asteroidGeometry.getAttribute('position');
        for (let i = 0; i < positionAttribute.count; i++) {
            const x = positionAttribute.getX(i);
            const y = positionAttribute.getY(i);
            const z = positionAttribute.getZ(i);
            const noise = 0.8 + Math.random() * 0.4;
            positionAttribute.setXYZ(i, x * noise, y * noise, z * noise);
        }
        asteroidGeometry.computeVertexNormals();
        
        const asteroidMaterial = new THREE.MeshPhongMaterial({ 
            color: 0x8b7355,
            emissive: 0x2a1a0a,
            emissiveIntensity: 0.1,
            shininess: 5,
            flatShading: true
        });
        
        const asteroid = new THREE.Mesh(asteroidGeometry, asteroidMaterial);
        asteroid.castShadow = true;
        asteroid.receiveShadow = true;
        asteroidGroup.add(asteroid);
        
        // Add asteroid glow for visibility
        const asteroidGlowGeometry = new THREE.SphereGeometry(10, 16, 16);
        const asteroidGlowMaterial = new THREE.MeshBasicMaterial({
            color: 0xff6633,
            transparent: true,
            opacity: 0.3
        });
        const asteroidGlow = new THREE.Mesh(asteroidGlowGeometry, asteroidGlowMaterial);
        asteroidGroup.add(asteroidGlow);
        
        // Add trail effect for asteroid
        const trailGeometry = new THREE.SphereGeometry(3, 8, 8);
        const trailMaterial = new THREE.MeshBasicMaterial({
            color: 0xff4422,
            transparent: true,
            opacity: 0.5
        });
        const asteroidTrail = new THREE.Mesh(trailGeometry, trailMaterial);
        asteroidGroup.add(asteroidTrail);
        
        scene.add(asteroidGroup);

        // Asteroid orbit line
        let asteroidOrbitLine = null;
        let impactMarker = null;

        // Trail for asteroid
        const asteroidTrailPoints = [];
        const MAX_TRAIL_POINTS = 50;
        let trailLine = null;

        // Asteroid data - initialize as null to prevent animation until data is loaded
        let asteroidData = null;
        let isDataLoaded = false;

        // Simulation state
        let time = 0;
        let timeSpeed = 1;
        let isPaused = false;
        let collisionDetected = false;
        let collisionTime = -1;

        // Orbital mechanics functions
        function solveKeplerEquation(M, e, tolerance = 1e-6) {
            let E = M;
            for (let i = 0; i < 30; i++) {
                const delta = E - e * Math.sin(E) - M;
                E -= delta / (1 - e * Math.cos(E));
                if (Math.abs(delta) < tolerance) break;
            }
            return E;
        }

        function calculateTrueAnomaly(E, e) {
            return 2 * Math.atan(Math.sqrt((1 + e) / (1 - e)) * Math.tan(E / 2));
        }

        function orbitalToCartesian(a, e, i, omega, w, M) {
            i *= Math.PI / 180;
            omega *= Math.PI / 180;
            w *= Math.PI / 180;
            M *= Math.PI / 180;
            
            const E = solveKeplerEquation(M, e);
            const nu = calculateTrueAnomaly(E, e);
            const r = a * (1 - e * Math.cos(E));
            
            const xOrb = r * Math.cos(nu);
            const yOrb = r * Math.sin(nu);
            
            const cosW = Math.cos(w), sinW = Math.sin(w);
            const cosI = Math.cos(i), sinI = Math.sin(i);
            const cosOmega = Math.cos(omega), sinOmega = Math.sin(omega);
            
            return {
                x: (cosW * cosOmega - sinW * sinOmega * cosI) * xOrb + 
                   (-sinW * cosOmega - cosW * sinOmega * cosI) * yOrb,
                y: (cosW * sinOmega + sinW * cosOmega * cosI) * xOrb + 
                   (-sinW * sinOmega + cosW * cosOmega * cosI) * yOrb,
                z: (sinW * sinI) * xOrb + (cosW * sinI) * yOrb,
                r: r,
                nu: nu
            };
        }

        function calculateOrbitalVelocity(r, a) {
            const rKm = r * AU_TO_KM;
            const aKm = a * AU_TO_KM;
            return Math.sqrt(MU_SUN * (2 / rKm - 1 / aKm));
        }

        // Update asteroid trail
        function updateAsteroidTrail(position) {
            asteroidTrailPoints.push(position.clone());
            if (asteroidTrailPoints.length > MAX_TRAIL_POINTS) {
                asteroidTrailPoints.shift();
            }
            
            if (trailLine) {
                scene.remove(trailLine);
            }
            
            if (asteroidTrailPoints.length > 1) {
                const trailGeometry = new THREE.BufferGeometry().setFromPoints(asteroidTrailPoints);
                const trailMaterial = new THREE.LineBasicMaterial({
                    color: 0xff6633,
                    transparent: true,
                    opacity: 0.5,
                    linewidth: 2
                });
                trailLine = new THREE.Line(trailGeometry, trailMaterial);
                scene.add(trailLine);
            }
        }

        // Fetch asteroid data from backend
        async function fetchAsteroidData() {
          const asteroidId = JSON.parse(localStorage.getItem("asteroid")).id;
          console.log(asteroidId)
          document.getElementById('asteroid-id').innerHTML = asteroidId
            document.getElementById('loading').style.display = 'block';
            document.getElementById('loading').textContent = '⏳ Fetching asteroid data...';
            
            try {
              console.log("trigger")
                const response = await fetch(`${BACKEND_URL}/asteroid/${asteroidId}`);
                const data = await response.json();
                
                if (data.error) {
                    alert('Error: ' + data.error);
                    document.getElementById('loading').style.display = 'none';
                    return;
                }
                
                // Update asteroid data
                asteroidData = {
                    name: data.name,
                    id: data.id,
                    orbitClass: data.orbital_elements.orbit_class,
                    hazardous: data.physical.hazardous,
                    diameter: (data.physical.diameter_min_km + data.physical.diameter_max_km) / 2,
                    magnitude: data.physical.absolute_magnitude_H,
                    a: parseFloat(data.orbital_elements.a_au),
                    e: parseFloat(data.orbital_elements.e),
                    i: parseFloat(data.orbital_elements.i_deg),
                    omega: parseFloat(data.orbital_elements.raan_deg),
                    w: parseFloat(data.orbital_elements.arg_peri_deg),
                    M0: parseFloat(data.orbital_elements.mean_anomaly_deg),
                    approachDate: data.close_approach?.date || 'N/A',
                    approachVelocity: parseFloat(data.close_approach?.relative_velocity_km_s) || 0
                };
                
                isDataLoaded = true;
                
                updateAsteroidDisplay();
                updateOrbitalInputs();
                recomputeOrbit();
                
                // Hide loading screen
                document.getElementById('loading').style.display = 'none';
                
            } catch (error) {
                alert('Failed to connect to backend: ' + error.message);
                document.getElementById('loading').style.display = 'none';
            }
        }

        function updateAsteroidDisplay() {
            if (!asteroidData) return;
            
            document.getElementById('ast-name').textContent = asteroidData.name;
            document.getElementById('ast-id').textContent = asteroidData.id;
            document.getElementById('ast-class').textContent = asteroidData.orbitClass;
            document.getElementById('ast-hazard').textContent = asteroidData.hazardous ? 'Yes' : 'No';
            document.getElementById('ast-hazard').className = asteroidData.hazardous ? 'info-value hazard-yes' : 'info-value hazard-no';
            document.getElementById('ast-diameter').textContent = asteroidData.diameter.toFixed(2) + ' km';
            document.getElementById('ast-mag').textContent = asteroidData.magnitude.toFixed(2);
            document.getElementById('ast-approach').textContent = asteroidData.approachDate;
            document.getElementById('phys-diameter').textContent = asteroidData.diameter.toFixed(2) + ' km';
            document.getElementById('phys-velocity').textContent = asteroidData.approachVelocity.toFixed(2) + ' km/s';
        }

        function updateOrbitalInputs() {
            if (!asteroidData) return;
            
            document.getElementById('slider-a').value = asteroidData.a;
            document.getElementById('input-a').value = asteroidData.a;
            document.getElementById('slider-e').value = asteroidData.e;
            document.getElementById('input-e').value = asteroidData.e;
            document.getElementById('slider-i').value = asteroidData.i;
            document.getElementById('input-i').value = asteroidData.i;
            document.getElementById('slider-omega').value = asteroidData.omega;
            document.getElementById('input-omega').value = asteroidData.omega;
            document.getElementById('slider-w').value = asteroidData.w;
            document.getElementById('input-w').value = asteroidData.w;
            document.getElementById('slider-m').value = asteroidData.M0;
            document.getElementById('input-m').value = asteroidData.M0;
        }

        function recomputeOrbit() {
            if (!asteroidData) return;
            
            if (asteroidOrbitLine) scene.remove(asteroidOrbitLine);
            
            const scaledA = asteroidData.a * AU_TO_UNITS;
            asteroidOrbitLine = createBoldOrbitLine(
                scaledA, asteroidData.e, asteroidData.i,
                asteroidData.omega, asteroidData.w, 0xff6622
            );
            scene.add(asteroidOrbitLine);
            
            const period = Math.pow(asteroidData.a, 1.5) * 365.25;
            document.getElementById('phys-period').textContent = period.toFixed(1) + ' days';
            document.getElementById('phys-motion').textContent = (360 / period).toFixed(2) + '°/day';
            
            collisionDetected = false;
            collisionTime = -1;
            
            // Clear trail
            asteroidTrailPoints.length = 0;
            if (trailLine) {
                scene.remove(trailLine);
                trailLine = null;
            }
        }

        // Collision detection with parameter sensitivity
        function runCollisionAnalysis() {
            if (!asteroidData) {
                alert('Please fetch asteroid data first!');
                return;
            }
            
            const samples = parseInt(document.getElementById('input-samples').value);
            const progressBar = document.getElementById('progress-bar');
            const progressFill = document.getElementById('progress-fill');
            const resultDiv = document.getElementById('collision-result');
            
            progressBar.style.display = 'block';
            let collisions = 0;
            let impactLocations = [];
            let minDistance = Infinity;
            let criticalParams = { a: false, e: false, i: false, omega: false, w: false, M0: false };
            
            // Test parameter sensitivity
            const paramTests = [
                { param: 'a', delta: 0.001 },
                { param: 'e', delta: 0.001 },
                { param: 'i', delta: 0.1 },
                { param: 'omega', delta: 0.5 },
                { param: 'w', delta: 0.5 },
                { param: 'M0', delta: 0.5 }
            ];
            
            paramTests.forEach(test => {
                const testData = {...asteroidData};
                testData[test.param] += test.delta;
                
                const scaledA = testData.a * AU_TO_UNITS;
                for (let t = 0; t < 365.25 * 2; t += 5) {
                    const M = testData.M0 + (t / (Math.pow(testData.a, 1.5) * 365.25)) * 360;
                    const astPos = orbitalToCartesian(scaledA, testData.e, testData.i,
                        testData.omega, testData.w, M);
                    
                    const earthM = (t / 365.25) * 360;
                    const earthPos = orbitalToCartesian(earthOrbitRadius, earthEccentricity, 0, 0, 0, earthM);
                    
                    const dist = Math.sqrt(
                        Math.pow(astPos.x - earthPos.x, 2) +
                        Math.pow(astPos.y - earthPos.y, 2) +
                        Math.pow(astPos.z - earthPos.z, 2)
                    );
                    
                    const distKm = (dist / AU_TO_UNITS) * AU_TO_KM;
                    if (distKm <= EARTH_RADIUS_KM * 10) {
                        criticalParams[test.param] = true;
                    }
                }
            });
            
            // Deterministic check
            const scaledA = asteroidData.a * AU_TO_UNITS;
            for (let t = 0; t < 365.25 * 2; t += 1) {
                const M = asteroidData.M0 + (t / (Math.pow(asteroidData.a, 1.5) * 365.25)) * 360;
                const astPos = orbitalToCartesian(scaledA, asteroidData.e, asteroidData.i,
                    asteroidData.omega, asteroidData.w, M);
                
                const earthM = (t / 365.25) * 360;
                const earthPos = orbitalToCartesian(earthOrbitRadius, earthEccentricity, 0, 0, 0, earthM);
                
                const dist = Math.sqrt(
                    Math.pow(astPos.x - earthPos.x, 2) +
                    Math.pow(astPos.y - earthPos.y, 2) +
                    Math.pow(astPos.z - earthPos.z, 2)
                );
                
                minDistance = Math.min(minDistance, dist);
                
                const distKm = (dist / AU_TO_UNITS) * AU_TO_KM;
                if (distKm <= EARTH_RADIUS_KM && collisionTime < 0) {
                    collisionTime = t;
                }
            }
            
            const minDistanceKm = (minDistance / AU_TO_UNITS) * AU_TO_KM;
            const willCollide = minDistanceKm <= EARTH_RADIUS_KM;
            
            // Monte Carlo
            for (let i = 0; i < samples; i++) {
                const perturbedData = {
                    a: asteroidData.a + (Math.random() - 0.5) * 0.001,
                    e: asteroidData.e + (Math.random() - 0.5) * 0.001,
                    i: asteroidData.i + (Math.random() - 0.5) * 0.1,
                    omega: asteroidData.omega + (Math.random() - 0.5) * 0.5,
                    w: asteroidData.w + (Math.random() - 0.5) * 0.5,
                    M0: asteroidData.M0 + (Math.random() - 0.5) * 0.5
                };
                
                let sampleCollides = false;
                for (let t = 0; t < 365.25 * 2 && !sampleCollides; t += 5) {
                    const M = perturbedData.M0 + (t / (Math.pow(perturbedData.a, 1.5) * 365.25)) * 360;
                    const scaledAPert = perturbedData.a * AU_TO_UNITS;
                    const astPos = orbitalToCartesian(scaledAPert, perturbedData.e, perturbedData.i,
                        perturbedData.omega, perturbedData.w, M);
                    
                    const earthM = (t / 365.25) * 360;
                    const earthPos = orbitalToCartesian(earthOrbitRadius, earthEccentricity, 0, 0, 0, earthM);
                    
                    const dist = Math.sqrt(
                        Math.pow(astPos.x - earthPos.x, 2) +
                        Math.pow(astPos.y - earthPos.y, 2) +
                        Math.pow(astPos.z - earthPos.z, 2)
                    );
                    
                    const distKm = (dist / AU_TO_UNITS) * AU_TO_KM;
                    if (distKm <= EARTH_RADIUS_KM) {
                        sampleCollides = true;
                        collisions++;
                        
                        const impactX = astPos.x - earthPos.x;
                        const impactY = astPos.y - earthPos.y;
                        const impactZ = astPos.z - earthPos.z;
                        const impactR = Math.sqrt(impactX*impactX + impactY*impactY + impactZ*impactZ);
                        
                        const lat = Math.asin(impactY / impactR) * 180 / Math.PI;
                        const lon = Math.atan2(impactZ, impactX) * 180 / Math.PI;
                        impactLocations.push({ lat, lon, x: impactX, y: impactY, z: impactZ });
                    }
                }
                progressFill.style.width = ((i + 1) / samples * 100) + '%';
            }
            
            const collisionProb = (collisions / samples) * 100;
            
            // Display critical parameters
            const criticalParamsList = Object.keys(criticalParams).filter(k => criticalParams[k]);
            let criticalParamsText = criticalParamsList.length > 0 
                ? '<div class="impact-info"><strong>Sensitive Parameters:</strong> ' + criticalParamsList.join(', ') + '</div>'
                : '';
            
            if (willCollide || collisionProb > 0) {
                collisionDetected = true;
                const mass = (4/3) * Math.PI * Math.pow(asteroidData.diameter / 2, 3) * 2.67e12;
                const velocity = asteroidData.approachVelocity * 1000;
                const energy = 0.5 * mass * velocity * velocity / 4.184e15;
                
                resultDiv.innerHTML = `
                    <div class="collision-warning">
                        <h3 style="color: #ff5252; margin-bottom: 10px;">⚠️ COLLISION DETECTED</h3>
                        <div class="impact-info"><strong>Probability:</strong> ${collisionProb.toFixed(2)}%</div>
                        <div class="impact-info"><strong>Min Distance:</strong> ${minDistanceKm.toFixed(0)} km</div>
                        <div class="impact-info"><strong>Impact Time:</strong> Day ${collisionTime.toFixed(0)}</div>
                        <div class="impact-info"><strong>Impact Energy:</strong> ${energy.toFixed(2)} megatons</div>
                        ${criticalParamsText}
                    </div>
                `;
            } else {
                collisionDetected = false;
                resultDiv.innerHTML = `
                    <div class="collision-safe">
                        <h3 style="color: #69f0ae; margin-bottom: 10px;">✅ SAFE TRAJECTORY</h3>
                        <div class="impact-info"><strong>Collision Probability:</strong> ${collisionProb.toFixed(4)}%</div>
                        <div class="impact-info"><strong>Min Distance:</strong> ${minDistanceKm.toFixed(0)} km</div>
                        ${criticalParamsText}
                    </div>
                `;
            }
            
            setTimeout(() => {
                progressBar.style.display = 'none';
                progressFill.style.width = '0%';
            }, 500);
        }

        // AI Agent Analysis
        function analyzeWithAI() {
            if (!asteroidData) {
                alert('Please fetch asteroid data first!');
                return;
            }
            
            const aiResult = document.getElementById('ai-result');
            const aiText = document.getElementById('ai-text');
            
            aiResult.style.display = 'block';
            aiText.innerHTML = 'Analyzing trajectory parameters...';
            
            setTimeout(() => {
                const period = Math.pow(asteroidData.a, 1.5) * 365.25;
                const perihelion = asteroidData.a * (1 - asteroidData.e);
                const aphelion = asteroidData.a * (1 + asteroidData.e);
                
                let riskLevel = 'LOW';
                let riskColor = '#69f0ae';
                
                if (perihelion < 1.0) {
                    if (asteroidData.hazardous) {
                        riskLevel = 'HIGH';
                        riskColor = '#ff5252';
                    } else {
                        riskLevel = 'MEDIUM';
                        riskColor = '#ffaa00';
                    }
                }
                
                aiText.innerHTML = `
                    <p><strong>Orbit Classification:</strong> ${asteroidData.orbitClass}</p>
                    <p><strong>Risk Assessment:</strong> <span style="color: ${riskColor};">${riskLevel}</span></p>
                    <p><strong>Perihelion:</strong> ${perihelion.toFixed(3)} AU (${perihelion < 1.0 ? 'Inside' : 'Outside'} Earth orbit)</p>
                    <p><strong>Aphelion:</strong> ${aphelion.toFixed(3)} AU</p>
                    <p><strong>Orbital Period:</strong> ${period.toFixed(1)} days</p>
                    <p><strong>Inclination Analysis:</strong> ${asteroidData.i < 10 ? 'Low inclination - increased interaction probability' : 'Moderate to high inclination'}</p>
                    <p><strong>Recommendation:</strong> ${asteroidData.hazardous ? 'Continuous monitoring recommended. Small parameter changes could significantly affect trajectory.' : 'Standard monitoring sufficient.'}</p>
                `;
            }, 1000);
        }

        // Camera controls
        class OrbitControls {
            constructor(camera, domElement) {
                this.camera = camera;
                this.domElement = domElement;
                this.isMouseDown = false;
                this.mouseX = 0;
                this.mouseY = 0;
                this.theta = Math.PI / 4;
                this.phi = Math.PI / 3;
                this.radius = 800;
                this.updateCamera();
                this.bindEvents();
            }
            
            bindEvents() {
                this.domElement.addEventListener('mousedown', this.onMouseDown.bind(this));
                this.domElement.addEventListener('mousemove', this.onMouseMove.bind(this));
                this.domElement.addEventListener('mouseup', this.onMouseUp.bind(this));
                this.domElement.addEventListener('wheel', this.onWheel.bind(this));
            }
            
            onMouseDown(e) {
                this.isMouseDown = true;
                this.mouseX = e.clientX;
                this.mouseY = e.clientY;
            }
            
            onMouseMove(e) {
                if (!this.isMouseDown) return;
                const deltaX = e.clientX - this.mouseX;
                const deltaY = e.clientY - this.mouseY;
                this.theta -= deltaX * 0.005;
                this.phi -= deltaY * 0.005;
                this.phi = Math.max(0.1, Math.min(Math.PI - 0.1, this.phi));
                this.updateCamera();
                this.mouseX = e.clientX;
                this.mouseY = e.clientY;
            }
            
            onMouseUp() {
                this.isMouseDown = false;
            }
            
            onWheel(e) {
                this.radius += e.deltaY * 0.5;
                this.radius = Math.max(200, Math.min(2000, this.radius));
                this.updateCamera();
            }
            
            updateCamera() {
                this.camera.position.x = this.radius * Math.sin(this.phi) * Math.cos(this.theta);
                this.camera.position.y = this.radius * Math.cos(this.phi);
                this.camera.position.z = this.radius * Math.sin(this.phi) * Math.sin(this.theta);
                this.camera.lookAt(0, 0, 0);
            }
        }

        const controls = new OrbitControls(camera, renderer.domElement);

        // Feature navigation
        document.querySelectorAll('.feature-icon').forEach(icon => {
            icon.addEventListener('click', () => {
                document.querySelectorAll('.feature-icon').forEach(i => i.classList.remove('active'));
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                
                icon.classList.add('active');
                const feature = icon.getAttribute('data-feature');
                document.getElementById('section-' + feature).classList.add('active');
            });
        });

        // Input synchronization
        function syncInputs(param) {
            const slider = document.getElementById(`slider-${param}`);
            const input = document.getElementById(`input-${param}`);
            
            slider.addEventListener('input', () => {
                input.value = slider.value;
                if (asteroidData) {
                    const key = param === 'omega' ? 'omega' : param === 'w' ? 'w' : param === 'm' ? 'M0' : param;
                    asteroidData[key] = parseFloat(slider.value);
                }
            });
            
            input.addEventListener('input', () => {
                slider.value = input.value;
                if (asteroidData) {
                    const key = param === 'omega' ? 'omega' : param === 'w' ? 'w' : param === 'm' ? 'M0' : param;
                    asteroidData[key] = parseFloat(input.value);
                }
            });
        }

        ['a', 'e', 'i', 'omega', 'w', 'm', 'speed'].forEach(syncInputs);

        // Button event listeners
        document.getElementById('btn-fetch').addEventListener('click', fetchAsteroidData);
        document.getElementById('btn-recompute').addEventListener('click', recomputeOrbit);
        document.getElementById('btn-collision').addEventListener('click', runCollisionAnalysis);
        document.getElementById('btn-ai-analyze').addEventListener('click', analyzeWithAI);

        document.getElementById('btn-play').addEventListener('click', () => {
            isPaused = false;
        });

        document.getElementById('btn-pause').addEventListener('click', () => {
            isPaused = true;
        });

        document.getElementById('btn-slow').addEventListener('click', () => {
            timeSpeed = 0.5;
            document.getElementById('slider-speed').value = 0.5;
            document.getElementById('input-speed').value = 0.5;
        });

        document.getElementById('btn-fast').addEventListener('click', () => {
            timeSpeed = 5;
            document.getElementById('slider-speed').value = 5;
            document.getElementById('input-speed').value = 5;
        });

        document.getElementById('btn-backward').addEventListener('click', () => {
            time = Math.max(0, time - 10);
        });

        document.getElementById('btn-forward').addEventListener('click', () => {
            time += 10;
        });

        document.getElementById('btn-reset').addEventListener('click', () => {
            time = 0;
            collisionDetected = false;
            document.getElementById('collision-impact').style.display = 'none';
            // Clear trail
            asteroidTrailPoints.length = 0;
            if (trailLine) {
                scene.remove(trailLine);
                trailLine = null;
            }
        });

        document.getElementById('btn-continue').addEventListener('click', () => {
            document.getElementById('collision-impact').style.display = 'none';
            isPaused = false;
        });

        document.getElementById('slider-speed').addEventListener('input', (e) => {
            timeSpeed = parseFloat(e.target.value);
        });

        // Navigation toggle
        const navToggle = document.getElementById('nav-toggle');
        const leftPanel = document.getElementById('left-panel');
        
        navToggle.addEventListener('click', () => {
            leftPanel.classList.toggle('hidden');
            rightPanel.classList.toggle('expanded');
            navToggle.classList.toggle('active');
            
            setTimeout(() => {
                const width = rightPanel.offsetWidth;
                const height = rightPanel.offsetHeight;
                camera.aspect = width / height;
                camera.updateProjectionMatrix();
                renderer.setSize(width, height);
            }, 400);
        });

        // Export functions
        document.getElementById('btn-export-img').addEventListener('click', () => {
            renderer.render(scene, camera);
            const dataURL = renderer.domElement.toDataURL('image/png');
            const link = document.createElement('a');
            link.download = 'asteroid_orbit_snapshot.png';
            link.href = dataURL;
            link.click();
        });

        document.getElementById('btn-export-json').addEventListener('click', () => {
            if (!asteroidData) {
                alert('Please fetch asteroid data first!');
                return;
            }
            const exportData = {
                asteroid: asteroidData,
                timestamp: new Date().toISOString(),
                orbitalPeriod: Math.pow(asteroidData.a, 1.5) * 365.25,
                meanMotion: 360 / (Math.pow(asteroidData.a, 1.5) * 365.25)
            };
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.download = 'asteroid_data.json';
            link.href = url;
            link.click();
        });

        // Initialize - DON'T call these until data is loaded
        document.getElementById('loading').style.display = 'block';
        document.getElementById('loading').textContent = '⏳ Please fetch asteroid data to begin...';

        // Animation loop
        function animate() {
            requestAnimationFrame(animate);

            // Only animate if data is loaded
            if (!isDataLoaded || !asteroidData) {
                // Rotate sun and starfield even when paused
                sunGroup.rotation.y += 0.001;
                starfieldGroup.rotation.y += 0.0001;
                renderer.render(scene, camera);
                return;
            }

            if (!isPaused) {
                // Update Earth position using the same orbital calculation as the orbit line
                const earthM = (time / 365.25) * 360; // Mean anomaly in degrees
                const earthPos = orbitalToCartesian(
                    earthOrbitRadius,  // semi-major axis
                    earthEccentricity, // eccentricity
                    0,                 // inclination (Earth's reference plane)
                    0,                 // RAAN
                    0,                 // argument of periapsis
                    earthM             // mean anomaly
                );
                
                // Move the container (orbital position)
                earthContainer.position.x = earthPos.x;
                earthContainer.position.y = earthPos.y;
                earthContainer.position.z = earthPos.z;
                
                // Rotate Earth on its tilted axis (daily rotation)
                earth.rotation.y += 0.01;
                clouds.rotation.y += 0.012;
                clouds.rotation.z += 0.001;

                // Update asteroid
                const period = Math.pow(asteroidData.a, 1.5) * 365.25;
                const M = asteroidData.M0 + (time / period) * 360;
                const scaledA = asteroidData.a * AU_TO_UNITS;
                const astPos = orbitalToCartesian(scaledA, asteroidData.e, asteroidData.i,
                    asteroidData.omega, asteroidData.w, M);
                
                asteroidGroup.position.set(astPos.x, astPos.y, astPos.z);
                asteroid.rotation.x += 0.02;
                asteroid.rotation.y += 0.03;
                
                // Update asteroid trail
                updateAsteroidTrail(asteroidGroup.position);

                // Check for collision (use earthContainer position)
                const distToEarth = Math.sqrt(
                    Math.pow(astPos.x - earthContainer.position.x, 2) +
                    Math.pow(astPos.y - earthContainer.position.y, 2) +
                    Math.pow(astPos.z - earthContainer.position.z, 2)
                );
                
                const distToEarthKm = (distToEarth / AU_TO_UNITS) * AU_TO_KM;
                
                if (distToEarthKm <= EARTH_RADIUS_KM && collisionDetected) {
                    isPaused = true;
                    document.getElementById('collision-impact').style.display = 'block';
                }

                // Update HUD
                const velocity = calculateOrbitalVelocity(astPos.r / AU_TO_UNITS, asteroidData.a);
                
                document.getElementById('hud-time').textContent = `Day ${Math.floor(time)}`;
                document.getElementById('hud-anomaly').textContent = (astPos.nu * 180 / Math.PI).toFixed(2) + '°';
                document.getElementById('hud-speed').textContent = velocity.toFixed(2) + ' km/s';
                document.getElementById('hud-distance').textContent = ((distToEarth / AU_TO_UNITS) * AU_TO_KM / 1e6).toFixed(2) + ' million km';
                document.getElementById('hud-radius').textContent = (astPos.r / AU_TO_UNITS).toFixed(3) + ' AU';

                sunGroup.rotation.y += 0.005;
                sunGlow.material.opacity = 0.4 + Math.sin(time * 0.1) * 0.1;
                sunCorona.material.opacity = 0.2 + Math.sin(time * 0.08) * 0.05;
                
                time += timeSpeed;
            }
            
            // Rotate starfield slowly
            starfieldGroup.rotation.y += 0.0001;

            renderer.render(scene, camera);
        }

        // Window resize
        window.addEventListener('resize', () => {
            const width = rightPanel.offsetWidth;
            const height = rightPanel.offsetHeight;
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
            renderer.setSize(width, height);
        });

        animate();
    </script>
</body>
</html>