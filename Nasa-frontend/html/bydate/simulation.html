<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AstroImpact Simulator — Advanced NEO Impact Analysis</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/jsm/controls/OrbitControls.js"></script>
  <style>
    :root {
      --bg-primary: #0a0e17;
      --bg-secondary: #0f1624;
      --bg-tertiary: #141e2e;
      --accent-primary: #00a8ff;
      --accent-secondary: #0097e6;
      --accent-tertiary: #0078c4;
      --text-primary: #e6f1ff;
      --text-secondary: #b0c8e6;
      --text-muted: #7a8ca5;
      --success: #00e676;
      --warning: #ffab00;
      --danger: #ff5252;
      --card-radius: 8px;
      --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
      --transition: all 0.3s ease;
      --glass: rgba(255, 255, 255, 0.05);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      overflow-x: hidden;
      font-weight: 400;
    }

    #app {
      display: grid;
      grid-template-columns: 300px 1fr 340px;
      grid-template-rows: 1fr auto;
      gap: 16px;
      padding: 16px;
      min-height: 100vh;
      grid-template-areas:
        "sidebar main right"
        "footer footer footer";
    }

    /* Sidebar */
    .sidebar {
      grid-area: sidebar;
      background: var(--bg-secondary);
      border-radius: var(--card-radius);
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      box-shadow: var(--card-shadow);
      border: 1px solid rgba(255, 255, 255, 0.05);
      transition: var(--transition);
    }

    .sidebar.collapsed {
      width: 60px;
      padding: 20px 10px;
    }

    .sidebar.collapsed .card-title span,
    .sidebar.collapsed .form-label,
    .sidebar.collapsed .form-input,
    .sidebar.collapsed .btn-text,
    .sidebar.collapsed .status-indicator span {
      display: none;
    }

    .sidebar.collapsed .card-title {
      justify-content: center;
    }

    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .sidebar-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--accent-primary);
    }

    .toggle-sidebar {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 16px;
      transition: var(--transition);
    }

    .toggle-sidebar:hover {
      color: var(--accent-primary);
    }

    .card {
      background: var(--bg-tertiary);
      border-radius: var(--card-radius);
      padding: 16px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .card-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--accent-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-title i {
      font-size: 14px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 13px;
      margin-bottom: 6px;
      color: var(--text-secondary);
    }

    .form-input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 6px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
      font-size: 14px;
      transition: var(--transition);
    }

    .form-input:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 2px rgba(0, 168, 255, 0.2);
    }

    .input-group {
      display: flex;
      gap: 8px;
    }

    .btn {
      padding: 10px 16px;
      border-radius: 6px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: var(--transition);
      justify-content: center;
      font-size: 14px;
    }

    .btn-primary {
      background: var(--accent-primary);
      color: white;
    }

    .btn-secondary {
      background: var(--glass);
      color: var(--text-primary);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 168, 255, 0.3);
    }

    .btn-full {
      width: 100%;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
    }

    .status-dot.warning {
      background: var(--warning);
    }

    .status-dot.error {
      background: var(--danger);
    }

    /* Main Content */
    .main {
      grid-area: main;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .simulation-container {
      background: var(--bg-secondary);
      border-radius: var(--card-radius);
      overflow: hidden;
      box-shadow: var(--card-shadow);
      border: 1px solid rgba(255, 255, 255, 0.05);
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .simulation-header {
      padding: 14px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .simulation-title {
      font-size: 16px;
      font-weight: 600;
    }

    .simulation-controls {
      display: flex;
      gap: 8px;
    }

    .simulation-body {
      flex: 1;
      position: relative;
      background: #000;
    }

    #three-container {
      width: 100%;
      height: 100%;
    }

    .visualization-panels {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .visualization-panel {
      background: var(--bg-secondary);
      border-radius: var(--card-radius);
      padding: 16px;
      box-shadow: var(--card-shadow);
      border: 1px solid rgba(255, 255, 255, 0.05);
      height: 280px;
      display: flex;
      flex-direction: column;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .panel-title {
      font-size: 15px;
      font-weight: 600;
    }

    .chart-container {
      flex: 1;
      position: relative;
    }

    .console {
      background: rgba(0, 0, 0, 0.4);
      border-radius: 6px;
      padding: 12px;
      flex: 1;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.4;
    }

    .console-line {
      margin-bottom: 4px;
    }

    .console-time {
      color: var(--text-muted);
    }

    .console-info {
      color: var(--accent-primary);
    }

    .console-warning {
      color: var(--warning);
    }

    .console-error {
      color: var(--danger);
    }

    /* Right Panel */
    .right-panel {
      grid-area: right;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .right-panel.collapsed {
      width: 60px;
    }

    .right-panel.collapsed .card-title span,
    .right-panel.collapsed .form-label,
    .right-panel.collapsed .form-input,
    .right-panel.collapsed .btn-text,
    .right-panel.collapsed .stat-card,
    .right-panel.collapsed .ai-header span,
    .right-panel.collapsed .ai-body,
    .right-panel.collapsed .ai-input-group {
      display: none;
    }

    .right-panel.collapsed .card-title {
      justify-content: center;
    }

    .impact-controls {
      background: var(--bg-secondary);
      border-radius: var(--card-radius);
      padding: 16px;
      box-shadow: var(--card-shadow);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 16px;
    }

    .stat-card {
      background: var(--bg-tertiary);
      border-radius: 6px;
      padding: 12px;
      text-align: center;
    }

    .stat-value {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 11px;
      color: var(--text-muted);
    }

    .ai-agent {
      background: var(--bg-secondary);
      border-radius: var(--card-radius);
      padding: 16px;
      box-shadow: var(--card-shadow);
      border: 1px solid rgba(255, 255, 255, 0.05);
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .ai-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .ai-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .ai-title {
      font-size: 15px;
      font-weight: 600;
    }

    .ai-body {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 6px;
      padding: 12px;
      flex: 1;
      overflow-y: auto;
      margin-bottom: 12px;
    }

    .ai-message {
      margin-bottom: 10px;
      padding: 8px;
      border-radius: 6px;
      max-width: 85%;
      font-size: 13px;
    }

    .ai-user {
      background: rgba(0, 168, 255, 0.1);
      margin-left: auto;
      border: 1px solid rgba(0, 168, 255, 0.2);
    }

    .ai-bot {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .ai-input-group {
      display: flex;
      gap: 8px;
    }

    .voice-btn {
      width: 40px;
      height: 40px;
      border-radius: 6px;
      background: var(--glass);
      border: 1px solid rgba(255, 255, 255, 0.08);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
    }

    .voice-btn:hover {
      background: rgba(0, 168, 255, 0.1);
      border-color: var(--accent-primary);
    }

    .voice-btn.recording {
      background: rgba(255, 82, 82, 0.2);
      border-color: var(--danger);
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(255, 82, 82, 0.4); }
      70% { box-shadow: 0 0 0 8px rgba(255, 82, 82, 0); }
      100% { box-shadow: 0 0 0 0 rgba(255, 82, 82, 0); }
    }

    /* Footer */
    .footer {
      grid-area: footer;
      background: var(--bg-secondary);
      border-radius: var(--card-radius);
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--card-shadow);
      border: 1px solid rgba(255, 255, 255, 0.05);
      font-size: 12px;
      color: var(--text-muted);
    }

    .footer-controls {
      display: flex;
      gap: 10px;
    }

    /* Loading Spinner */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: var(--accent-primary);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Protect Earth Section */
    .protect-earth {
      background: var(--bg-secondary);
      border-radius: var(--card-radius);
      padding: 16px;
      box-shadow: var(--card-shadow);
      border: 1px solid rgba(255, 255, 255, 0.05);
      margin-top: 16px;
    }

    .protection-methods {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 12px;
    }

    .method-card {
      background: var(--bg-tertiary);
      border-radius: 6px;
      padding: 12px;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
    }

    .method-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      border-color: var(--accent-primary);
    }

    .method-icon {
      font-size: 24px;
      margin-bottom: 8px;
      color: var(--accent-primary);
    }

    .method-name {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .method-desc {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* Responsive */
    @media (max-width: 1200px) {
      #app {
        grid-template-columns: 1fr;
        grid-template-areas:
          "main"
          "sidebar"
          "right"
          "footer";
      }
      
      .visualization-panels {
        grid-template-columns: 1fr;
      }
      
      .protection-methods {
        grid-template-columns: 1fr 1fr;
      }
    }

    @media (max-width: 768px) {
      .protection-methods {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-title">Controls</div>
        <button class="toggle-sidebar" id="toggle-sidebar">
          <i class="fas fa-chevron-left"></i>
        </button>
      </div>

      <div class="card">
        <div class="card-title"><i class="fas fa-asteroid"></i> <span>Asteroid Data</span></div>
        <div class="form-group">
          <div class="status-indicator">
            <div class="status-dot" id="data-status"></div>
            <span>Data Status: <span id="data-status-text">Loading...</span></span>
          </div>
        </div>
        <div class="input-group">
          <button class="btn btn-primary btn-full" id="load-data">
            <i class="fas fa-sync-alt"></i> <span class="btn-text">Load Asteroid Data</span>
          </button>
        </div>
      </div>

      <div class="card">
        <div class="card-title"><i class="fas fa-sliders-h"></i> <span>Simulation Parameters</span></div>
        <div class="form-group">
          <label class="form-label">Size (meters)</label>
          <input type="number" class="form-input" id="size-m" placeholder="Loading...">
        </div>
        <div class="form-group">
          <label class="form-label">Velocity (km/s)</label>
          <input type="number" class="form-input" id="vel-kms" placeholder="Loading...">
        </div>
        <div class="form-group">
          <label class="form-label">Density (kg/m³)</label>
          <input type="number" class="form-input" id="density" placeholder="Loading...">
        </div>
        <div class="form-group">
          <label class="form-label">Impact Angle (degrees)</label>
          <input type="number" class="form-input" id="impact-angle" value="45" min="0" max="90">
        </div>
      </div>

      <div class="card">
        <div class="card-title"><i class="fas fa-satellite-dish"></i> <span>System Status</span></div>
        <div class="form-group">
          <div class="status-indicator">
            <div class="status-dot" id="backend-status"></div>
            <span>Backend: <span id="backend-status-text">Checking...</span></span>
          </div>
        </div>
        <div class="form-group">
          <div class="status-indicator">
            <div class="status-dot" id="data-stream-status"></div>
            <span>Data Stream: <span id="data-stream-status-text">Checking...</span></span>
          </div>
        </div>
        <div class="form-group">
          <div class="status-indicator">
            <div class="status-dot" id="simulation-status"></div>
            <span>Simulation: <span id="simulation-status-text">Ready</span></span>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-title"><i class="fas fa-cogs"></i> <span>Visualization</span></div>
        <div class="form-group">
          <label class="form-label">Trajectory Detail</label>
          <input type="range" class="form-input" id="trajectory-detail" min="10" max="1000" value="400">
        </div>
        <div class="form-group">
          <label class="form-label">Time Scale</label>
          <input type="range" class="form-input" id="time-scale" min="1" max="10" value="1">
        </div>
        <div class="input-group">
          <button class="btn btn-secondary btn-full" id="fullscreen-btn">
            <i class="fas fa-expand"></i> <span class="btn-text">Full Screen</span>
          </button>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main">
      <div class="simulation-container">
        <div class="simulation-header">
          <div class="simulation-title">3D Impact Simulation</div>
          <div class="simulation-controls">
            <button class="btn btn-secondary" id="play-pause">
              <i class="fas fa-pause"></i> Pause
            </button>
            <button class="btn btn-secondary" id="reset-view">
              <i class="fas fa-sync-alt"></i> Reset
            </button>
            <button class="btn btn-primary" id="capture-view">
              <i class="fas fa-camera"></i> Capture
            </button>
          </div>
        </div>
        <div class="simulation-body">
          <div id="three-container"></div>
        </div>
      </div>

      <div class="visualization-panels">
        <div class="visualization-panel">
          <div class="panel-header">
            <div class="panel-title">Impact Energy & Effects</div>
            <button class="btn btn-secondary" style="padding: 6px 10px; font-size: 12px;">
              <i class="fas fa-expand"></i>
            </button>
          </div>
          <div class="chart-container">
            <canvas id="energyChart"></canvas>
          </div>
        </div>

        <div class="visualization-panel">
          <div class="panel-header">
            <div class="panel-title">System Console</div>
            <button class="btn btn-secondary" style="padding: 6px 10px; font-size: 12px;" id="clear-console">
              <i class="fas fa-trash"></i>
            </button>
          </div>
          <div class="console" id="console">
            <div class="console-line">
              <span class="console-time">[14:22:35]</span>
              <span class="console-info">System initialized successfully</span>
            </div>
            <div class="console-line">
              <span class="console-time">[14:22:40]</span>
              <span class="console-info">Loading asteroid data from localStorage...</span>
            </div>
          </div>
        </div>
      </div>

      <div class="protect-earth">
        <div class="card-title"><i class="fas fa-shield-alt"></i> Protect Earth - Deflection Methods</div>
        <div class="protection-methods">
          <div class="method-card" id="kinetic-impactor">
            <div class="method-icon"><i class="fas fa-meteor"></i></div>
            <div class="method-name">Kinetic Impactor</div>
            <div class="method-desc">Strike asteroid with projectile to alter trajectory</div>
          </div>
          <div class="method-card" id="gravity-tractor">
            <div class="method-icon"><i class="fas fa-tractor"></i></div>
            <div class="method-name">Gravity Tractor</div>
            <div class="method-desc">Use spacecraft gravity to slowly pull asteroid</div>
          </div>
          <div class="method-card" id="nuclear-deflection">
            <div class="method-icon"><i class="fas fa-atom"></i></div>
            <div class="method-name">Nuclear Deflection</div>
            <div class="method-desc">Detonate nuclear device near asteroid surface</div>
          </div>
        </div>
      </div>
    </main>

    <!-- Right Panel -->
    <div class="right-panel" id="right-panel">
      <div class="impact-controls">
        <div class="card-title"><i class="fas fa-bullseye"></i> <span>Impact Control</span></div>
        
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="energy">-</div>
            <div class="stat-label">Impact Energy</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="crater">-</div>
            <div class="stat-label">Crater Diameter</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="magnitude">-</div>
            <div class="stat-label">Seismic Magnitude</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="tsunami">-</div>
            <div class="stat-label">Tsunami Height</div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Impact Coordinates</label>
          <div class="input-group">
            <input type="number" class="form-input" id="impact-lat" placeholder="Latitude" step="0.01" value="34.05">
            <input type="number" class="form-input" id="impact-lon" placeholder="Longitude" step="0.01" value="-118.25">
          </div>
        </div>

        <div class="input-group">
          <button class="btn btn-primary" id="simulate-btn" style="flex: 1;">
            <i class="fas fa-bolt"></i> <span class="btn-text">Simulate Impact</span>
          </button>
          <button class="btn btn-secondary" id="deflect-btn">
            <i class="fas fa-shield-alt"></i>
          </button>
        </div>
      </div>

      <div class="ai-agent">
        <div class="ai-header">
          <div class="ai-avatar">
            <i class="fas fa-robot"></i>
          </div>
          <div class="ai-title">AI Impact Analyst</div>
        </div>
        
        <div class="ai-body" id="ai-chat">
          <div class="ai-message ai-bot">
            Hello! I'm your AI Impact Analyst. I can answer questions about asteroid impacts, simulation parameters, and potential effects. How can I assist you today?
          </div>
        </div>
        
        <div class="ai-input-group">
          <input type="text" class="form-input" id="q-input" placeholder="Ask about the simulation...">
          <div class="voice-btn" id="voice-btn">
            <i class="fas fa-microphone"></i>
          </div>
          <button class="btn btn-primary" id="ask-btn">Ask</button>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
      <div class="status-indicator">
        <div class="status-dot" id="footer-status"></div>
        <span>Simulation Status: <span id="status">Initializing...</span></span>
      </div>
      <div class="footer-controls">
        <button class="btn btn-secondary" id="toggle-right-panel">
          <i class="fas fa-chevron-right"></i> Toggle Panel
        </button>
        <button class="btn btn-secondary" id="export-data">
          <i class="fas fa-download"></i> Export Data
        </button>
      </div>
    </footer>
  </div>

  <script>
    // ---------- Three.js Scene Setup ----------
    const container = document.getElementById('three-container');
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1e7);
    camera.position.set(0, 50, 220);

    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.setClearColor(0x000000, 0);
    container.appendChild(renderer.domElement);

    // OrbitControls
    let controls;
    if (typeof THREE.OrbitControls !== 'undefined') {
      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
    }

    // Lighting
    const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.8);
    scene.add(hemiLight);
    
    const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
    dirLight.position.set(100, 100, 50);
    scene.add(dirLight);

    // Earth
    const earthGeometry = new THREE.SphereGeometry(63, 48, 48);
    const earthTexture = createEarthTexture();
    const earthMaterial = new THREE.MeshPhongMaterial({ map: earthTexture });
    const earth = new THREE.Mesh(earthGeometry, earthMaterial);
    scene.add(earth);

    // Atmosphere
    const atmosphereGeometry = new THREE.SphereGeometry(64, 48, 48);
    const atmosphereMaterial = new THREE.MeshPhongMaterial({
      color: 0x48c9ff,
      transparent: true,
      opacity: 0.1
    });
    const atmosphere = new THREE.Mesh(atmosphereGeometry, atmosphereMaterial);
    scene.add(atmosphere);

    // Asteroid
    let asteroidMesh = null;
    function createAsteroid(radius = 5) {
      if (asteroidMesh) scene.remove(asteroidMesh);
      
      const geometry = new THREE.IcosahedronGeometry(radius, 1);
      const material = new THREE.MeshPhongMaterial({
        color: 0xb77d3a,
        shininess: 30,
        specular: 0x222222
      });
      
      asteroidMesh = new THREE.Mesh(geometry, material);
      scene.add(asteroidMesh);
      
      // Add a subtle glow effect
      const glowGeometry = new THREE.IcosahedronGeometry(radius * 1.2, 1);
      const glowMaterial = new THREE.MeshBasicMaterial({
        color: 0xffaa33,
        transparent: true,
        opacity: 0.2
      });
      const glow = new THREE.Mesh(glowGeometry, glowMaterial);
      asteroidMesh.add(glow);
      
      return asteroidMesh;
    }
    createAsteroid(5);

    // Create a simple starfield
    const starsGeometry = new THREE.BufferGeometry();
    const starsCount = 5000;
    const positions = new Float32Array(starsCount * 3);
    
    for (let i = 0; i < starsCount * 3; i++) {
      positions[i] = (Math.random() - 0.5) * 2000;
    }
    
    starsGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
    const starsMaterial = new THREE.PointsMaterial({
      color: 0xffffff,
      size: 1,
      transparent: true
    });
    const starField = new THREE.Points(starsGeometry, starsMaterial);
    scene.add(starField);

    // Create Earth texture programmatically
    function createEarthTexture() {
      const canvas = document.createElement('canvas');
      canvas.width = 512;
      canvas.height = 512;
      const context = canvas.getContext('2d');
      
      // Blue ocean base
      context.fillStyle = '#1a3c5e';
      context.fillRect(0, 0, 512, 512);
      
      // Add some land masses
      context.fillStyle = '#2d5c3d';
      context.beginPath();
      context.ellipse(150, 200, 80, 60, 0, 0, Math.PI * 2);
      context.fill();
      
      context.beginPath();
      context.ellipse(350, 300, 60, 70, 0, 0, Math.PI * 2);
      context.fill();
      
      context.beginPath();
      context.ellipse(400, 150, 50, 40, 0, 0, Math.PI * 2);
      context.fill();
      
      // Add cloud cover
      context.fillStyle = 'rgba(255, 255, 255, 0.3)';
      context.beginPath();
      context.ellipse(250, 100, 100, 40, 0, 0, Math.PI * 2);
      context.fill();
      
      context.beginPath();
      context.ellipse(100, 350, 70, 30, 0, 0, Math.PI * 2);
      context.fill();
      
      const texture = new THREE.CanvasTexture(canvas);
      return texture;
    }

    // Handle window resize
    window.addEventListener('resize', () => {
      renderer.setSize(container.clientWidth, container.clientHeight);
      camera.aspect = container.clientWidth / container.clientHeight;
      camera.updateProjectionMatrix();
    });

    // Animation loop
    function animate() {
      requestAnimationFrame(animate);
      if (controls) controls.update();
      
      // Rotate Earth
      earth.rotation.y += 0.001;
      atmosphere.rotation.y += 0.001;
      
      // Rotate asteroid if it exists
      if (asteroidMesh) {
        asteroidMesh.rotation.x += 0.01;
        asteroidMesh.rotation.y += 0.005;
      }
      
      renderer.render(scene, camera);
    }
    animate();

    // ---------- Application State & Data Management ----------
    let asteroidData = null;
    let isSimulationRunning = true;
    const BACKEND_URL = 'http://localhost:5000'; // Update with your backend URL

    // Load asteroid data from backend
    async function loadAsteroidData() {
      const asteroidID = localStorage.getItem("astroidID") || "3542519";
      logToConsole(`Loading asteroid data for ID: ${asteroidID}`, 'info');
      
      // Show loading state
      document.getElementById('data-status').className = 'status-dot warning';
      document.getElementById('data-status-text').textContent = 'Loading...';
      document.getElementById('load-data').innerHTML = '<div class="loading"></div> <span class="btn-text">Loading...</span>';
      
      try {
        const response = await fetch(`${BACKEND_URL}/api/neo/${asteroidID}`);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        asteroidData = await response.json();
        
        // Update UI with loaded data
        document.getElementById('size-m').value = asteroidData.diameter || 320;
        document.getElementById('vel-kms').value = asteroidData.velocity || 15.2;
        document.getElementById('density').value = asteroidData.density || 2600;
        
        document.getElementById('data-status').className = 'status-dot';
        document.getElementById('data-status-text').textContent = 'Loaded';
        document.getElementById('load-data').innerHTML = '<i class="fas fa-sync-alt"></i> <span class="btn-text">Refresh Data</span>';
        
        logToConsole(`Asteroid data loaded: ${asteroidData.name || `Asteroid ${asteroidID}`}`, 'info');
        updateAsteroidVisualization();
        
      } catch (error) {
        console.error('Error loading asteroid data:', error);
        document.getElementById('data-status').className = 'status-dot error';
        document.getElementById('data-status-text').textContent = 'Error';
        document.getElementById('load-data').innerHTML = '<i class="fas fa-sync-alt"></i> <span class="btn-text">Retry</span>';
        
        logToConsole(`Failed to load asteroid data: ${error.message}`, 'error');
      }
    }

    // Update asteroid visualization based on data
    function updateAsteroidVisualization() {
      if (!asteroidData) return;
      
      const size = asteroidData.diameter || 320;
      // Scale down for visualization
      const visualSize = Math.min(Math.max(size / 100, 2), 20);
      createAsteroid(visualSize);
      
      logToConsole(`Updated asteroid visualization: ${visualSize.toFixed(1)} units`, 'info');
    }

    // Run impact simulation
    async function runSimulation() {
      const size = parseFloat(document.getElementById('size-m').value) || 320;
      const velocity = parseFloat(document.getElementById('vel-kms').value) || 15.2;
      const density = parseFloat(document.getElementById('density').value) || 2600;
      const impactAngle = parseFloat(document.getElementById('impact-angle').value) || 45;
      const lat = parseFloat(document.getElementById('impact-lat').value) || 34.05;
      const lon = parseFloat(document.getElementById('impact-lon').value) || -118.25;
      
      logToConsole(`Starting simulation: ${size}m, ${velocity}km/s, ${density}kg/m³`, 'info');
      
      // Show simulation running state
      document.getElementById('simulation-status').className = 'status-dot warning';
      document.getElementById('simulation-status-text').textContent = 'Running...';
      document.getElementById('simulate-btn').innerHTML = '<div class="loading"></div> <span class="btn-text">Simulating...</span>';
      
      try {
        const response = await fetch(`${BACKEND_URL}/api/simulate`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            size: size,
            velocity: velocity,
            density: density,
            impact_angle: impactAngle,
            lat: lat,
            lon: lon
          })
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const simulationResults = await response.json();
        
        // Update UI with simulation results
        updateSimulationResults(simulationResults);
        
        document.getElementById('simulation-status').className = 'status-dot';
        document.getElementById('simulation-status-text').textContent = 'Complete';
        document.getElementById('simulate-btn').innerHTML = '<i class="fas fa-bolt"></i> <span class="btn-text">Simulate Impact</span>';
        
        logToConsole(`Simulation completed successfully`, 'info');
        
      } catch (error) {
        console.error('Error running simulation:', error);
        document.getElementById('simulation-status').className = 'status-dot error';
        document.getElementById('simulation-status-text').textContent = 'Error';
        document.getElementById('simulate-btn').innerHTML = '<i class="fas fa-bolt"></i> <span class="btn-text">Retry Simulation</span>';
        
        logToConsole(`Simulation failed: ${error.message}`, 'error');
      }
    }

    // Update UI with simulation results
    function updateSimulationResults(results) {
      // Update impact stats
      if (results.energy) {
        document.getElementById('energy').textContent = formatEnergy(results.energy);
      }
      if (results.crater_diameter) {
        document.getElementById('crater').textContent = formatDistance(results.crater_diameter);
      }
      if (results.seismic_magnitude) {
        document.getElementById('magnitude').textContent = `M ${results.seismic_magnitude.toFixed(1)}`;
      }
      if (results.tsunami_height) {
        document.getElementById('tsunami').textContent = formatDistance(results.tsunami_height);
      }
      
      // Update charts
      updateEnergyChart(results);
      
      // Add AI analysis
      addAIAnalysis(results);
    }

    // Format energy for display
    function formatEnergy(energy) {
      if (energy >= 1e18) {
        return (energy / 1e18).toFixed(2) + ' GT';
      } else if (energy >= 1e15) {
        return (energy / 1e15).toFixed(2) + ' MT';
      } else {
        return (energy / 1e12).toFixed(2) + ' kT';
      }
    }

    // Format distance for display
    function formatDistance(distance) {
      if (distance >= 1000) {
        return (distance / 1000).toFixed(1) + ' km';
      } else {
        return distance.toFixed(0) + ' m';
      }
    }

    // Update energy chart with simulation results
    function updateEnergyChart(results) {
      const ctx = document.getElementById('energyChart').getContext('2d');
      
      // Destroy existing chart if it exists
      if (window.energyChart) {
        window.energyChart.destroy();
      }
      
      window.energyChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Impact Energy', 'Seismic Energy', 'Thermal Radiation', 'Ejecta'],
          datasets: [{
            label: 'Energy Distribution',
            data: [
              results.energy || 1e15,
              results.seismic_energy || 1e13,
              results.thermal_energy || 1e14,
              results.ejecta_energy || 1e13
            ],
            backgroundColor: [
              'rgba(255, 99, 132, 0.7)',
              'rgba(54, 162, 235, 0.7)',
              'rgba(255, 206, 86, 0.7)',
              'rgba(75, 192, 192, 0.7)'
            ],
            borderColor: [
              'rgba(255, 99, 132, 1)',
              'rgba(54, 162, 235, 1)',
              'rgba(255, 206, 86, 1)',
              'rgba(75, 192, 192, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              type: 'logarithmic',
              beginAtZero: true,
              title: {
                display: true,
                text: 'Energy (Joules)'
              }
            }
          },
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  let value = context.raw;
                  if (value >= 1e18) {
                    return (value / 1e18).toFixed(2) + ' GT TNT';
                  } else if (value >= 1e15) {
                    return (value / 1e15).toFixed(2) + ' MT TNT';
                  } else {
                    return (value / 1e12).toFixed(2) + ' kT TNT';
                  }
                }
              }
            }
          }
        }
      });
    }

    // Add AI analysis of simulation results
    function addAIAnalysis(results) {
      const aiChat = document.getElementById('ai-chat');
      const energy = results.energy || 0;
      
      let analysis = '';
      if (energy < 1e12) {
        analysis = "This is a small impact event, comparable to a large conventional bomb. Local damage would be limited to the immediate impact area.";
      } else if (energy < 1e15) {
        analysis = "This impact would release energy comparable to a nuclear weapon. Significant local destruction would occur, with potential regional effects.";
      } else if (energy < 1e18) {
        analysis = "This is a major impact event with regional to continental consequences. Widespread destruction, firestorms, and potential climate effects would occur.";
      } else {
        analysis = "This is a catastrophic impact event with global consequences. Mass extinction-level event with long-term climate changes.";
      }
      
      const message = document.createElement('div');
      message.className = 'ai-message ai-bot';
      message.innerHTML = `<strong>Impact Analysis:</strong> ${analysis}`;
      aiChat.appendChild(message);
      aiChat.scrollTop = aiChat.scrollHeight;
    }

    // Log messages to console
    function logToConsole(message, type = 'info') {
      const console = document.getElementById('console');
      const now = new Date();
      const timeString = `[${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}]`;
      
      const line = document.createElement('div');
      line.className = 'console-line';
      
      const timeSpan = document.createElement('span');
      timeSpan.className = 'console-time';
      timeSpan.textContent = timeString;
      
      const messageSpan = document.createElement('span');
      messageSpan.className = `console-${type}`;
      messageSpan.textContent = ` ${message}`;
      
      line.appendChild(timeSpan);
      line.appendChild(messageSpan);
      console.appendChild(line);
      console.scrollTop = console.scrollHeight;
    }

    // ---------- UI Event Handlers ----------
    document.getElementById('load-data').addEventListener('click', loadAsteroidData);
    document.getElementById('simulate-btn').addEventListener('click', runSimulation);
    document.getElementById('clear-console').addEventListener('click', () => {
      document.getElementById('console').innerHTML = '';
      logToConsole('Console cleared', 'info');
    });
    
    document.getElementById('play-pause').addEventListener('click', function() {
      isSimulationRunning = !isSimulationRunning;
      this.innerHTML = isSimulationRunning ? 
        '<i class="fas fa-pause"></i> Pause' : 
        '<i class="fas fa-play"></i> Play';
      logToConsole(`Simulation ${isSimulationRunning ? 'resumed' : 'paused'}`, 'info');
    });
    
    document.getElementById('reset-view').addEventListener('click', function() {
      if (controls) {
        controls.reset();
      }
      logToConsole('View reset', 'info');
    });
    
    document.getElementById('capture-view').addEventListener('click', function() {
      // In a real implementation, this would capture the current view
      logToConsole('View captured (saved to gallery)', 'info');
    });
    
    document.getElementById('toggle-sidebar').addEventListener('click', function() {
      const sidebar = document.getElementById('sidebar');
      sidebar.classList.toggle('collapsed');
      this.innerHTML = sidebar.classList.contains('collapsed') ? 
        '<i class="fas fa-chevron-right"></i>' : 
        '<i class="fas fa-chevron-left"></i>';
    });
    
    document.getElementById('toggle-right-panel').addEventListener('click', function() {
      const rightPanel = document.getElementById('right-panel');
      rightPanel.classList.toggle('collapsed');
      this.innerHTML = rightPanel.classList.contains('collapsed') ? 
        '<i class="fas fa-chevron-left"></i> Toggle Panel' : 
        '<i class="fas fa-chevron-right"></i> Toggle Panel';
    });
    
    document.getElementById('fullscreen-btn').addEventListener('click', function() {
      if (container.requestFullscreen) {
        container.requestFullscreen();
      } else if (container.webkitRequestFullscreen) {
        container.webkitRequestFullscreen();
      }
      logToConsole('Entered fullscreen mode', 'info');
    });
    
    document.getElementById('export-data').addEventListener('click', function() {
      // In a real implementation, this would export simulation data
      logToConsole('Data exported to CSV', 'info');
    });
    
    document.getElementById('deflect-btn').addEventListener('click', function() {
      logToConsole('Deflection simulation initiated', 'info');
    });
    
    // Protection method buttons
    document.getElementById('kinetic-impactor').addEventListener('click', function() {
      logToConsole('Kinetic impactor deflection method selected', 'info');
    });
    
    document.getElementById('gravity-tractor').addEventListener('click', function() {
      logToConsole('Gravity tractor deflection method selected', 'info');
    });
    
    document.getElementById('nuclear-deflection').addEventListener('click', function() {
      logToConsole('Nuclear deflection method selected', 'info');
    });
    
    // AI chat functionality
    document.getElementById('ask-btn').addEventListener('click', function() {
      const question = document.getElementById('q-input').value.trim();
      if (question) {
        const aiChat = document.getElementById('ai-chat');
        
        // Add user message
        const userMessage = document.createElement('div');
        userMessage.className = 'ai-message ai-user';
        userMessage.textContent = question;
        aiChat.appendChild(userMessage);
        
        // Clear input
        document.getElementById('q-input').value = '';
        
        // Simulate AI response
        setTimeout(() => {
          const botMessage = document.createElement('div');
          botMessage.className = 'ai-message ai-bot';
          botMessage.textContent = getAIResponse(question);
          aiChat.appendChild(botMessage);
          aiChat.scrollTop = aiChat.scrollHeight;
        }, 1000);
      }
    });
    
    // Voice input functionality
    let isRecording = false;
    document.getElementById('voice-btn').addEventListener('click', function() {
      isRecording = !isRecording;
      this.classList.toggle('recording', isRecording);
      this.innerHTML = isRecording ? 
        '<i class="fas fa-stop"></i>' : 
        '<i class="fas fa-microphone"></i>';
      
      if (isRecording) {
        logToConsole('Voice recording started', 'info');
      } else {
        logToConsole('Voice recording stopped', 'info');
      }
    });

    // AI response generator (simplified)
    function getAIResponse(question) {
      const responses = [
        "Based on the current simulation parameters, the impact would create a crater approximately 5km in diameter.",
        "The energy released would be equivalent to about 150 megatons of TNT, similar to a large nuclear weapon.",
        "For an asteroid of this size, deflection would require at least 10 years of advance warning.",
        "The seismic effects would be felt up to 500km from the impact site, with potential magnitude 6.0+ earthquakes.",
        "Tsunami waves could reach heights of 20 meters along nearby coastlines.",
        "The atmospheric blast would shatter windows within a 100km radius of the impact."
      ];
      
      return responses[Math.floor(Math.random() * responses.length)];
    }

    // ---------- Initialization ----------
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize charts
      const ctx = document.getElementById('energyChart').getContext('2d');
      window.energyChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Impact Energy', 'Seismic Energy', 'Thermal Radiation', 'Ejecta'],
          datasets: [{
            label: 'Energy Distribution',
            data: [1e15, 1e13, 1e14, 1e13],
            backgroundColor: [
              'rgba(255, 99, 132, 0.7)',
              'rgba(54, 162, 235, 0.7)',
              'rgba(255, 206, 86, 0.7)',
              'rgba(75, 192, 192, 0.7)'
            ],
            borderColor: [
              'rgba(255, 99, 132, 1)',
              'rgba(54, 162, 235, 1)',
              'rgba(255, 206, 86, 1)',
              'rgba(75, 192, 192, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              type: 'logarithmic',
              beginAtZero: true
            }
          },
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });
      
      // Load asteroid data on startup
      loadAsteroidData();
      
      // Check backend status
      checkBackendStatus();
      
      // Update footer status
      document.getElementById('footer-status').className = 'status-dot';
      document.getElementById('status').textContent = 'Ready';
      
      logToConsole('AstroImpact Simulator initialized successfully', 'info');
    });

    // Check backend connectivity
    async function checkBackendStatus() {
      try {
        const response = await fetch(`${BACKEND_URL}/api/neo/3542519`);
        if (response.ok) {
          document.getElementById('backend-status').className = 'status-dot';
          document.getElementById('backend-status-text').textContent = 'Connected';
        } else {
          throw new Error('Backend responded with error');
        }
      } catch (error) {
        document.getElementById('backend-status').className = 'status-dot error';
        document.getElementById('backend-status-text').textContent = 'Disconnected';
        logToConsole('Backend connection failed', 'error');
      }
    }
  </script>
</body>
</html>